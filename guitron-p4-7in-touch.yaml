################################################################################
# Substitution Variables
################################################################################
substitutions:
  device_internal_name: guitron_p4_7in_touch
  device_wifi_name: "guitron-p4-7in-touch2"
  friendly_name: Guitron-P4 7in touch
  volume_minus: "\ue04d"
  volume_plus:  "\ue050"
  power:        "\uf16f"
  wifi:         "\ue63e"
  wifi_off:     "\ue648"
  left:         "\ue5c4"
  right:        "\ue5c8"
  up:           "\ue5d8"
  down:         "\ue5db"

# We won't need this once this board is added to ESPhome
# external_components:
#   - source: github://pr#11886
#     components: [mipi_dsi]
#     refresh: 1h

esphome:
  name: ${device_wifi_name}
  friendly_name: ${friendly_name}

esp32:
  variant: esp32p4
  flash_size: 16MB
  cpu_frequency: 360MHz
  framework:
    type: esp-idf
    advanced:
      enable_idf_experimental_features: true
  
esp32_hosted:
  variant: ESP32C6
  reset_pin: GPIO54
  cmd_pin: GPIO19
  clk_pin: GPIO18
  d0_pin: GPIO14
  d1_pin: GPIO15
  d2_pin: GPIO16
  d3_pin: GPIO17
  active_high: true

psram:
  mode: hex
  speed: 200MHz

preferences:
  flash_write_interval: 5min

################################################################################
# WiFi
################################################################################
wifi:
  networks:
    - ssid: !secret wifi_ssid
      password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "${device_wifi_name} Hotspot"
    password: !secret wifi_ap_password
  
captive_portal:

# ethernet:
#   type: IP101
#   mdc_pin: GPIO31
#   mdio_pin: GPIO52
#   clk: 
#     pin: GPIO50
#     mode: CLK_EXT_IN
#   phy_addr: 1
#   power_pin: GPIO51

################################################################################
# Enable logging
################################################################################
logger:
  level: DEBUG
  hardware_uart: USB_SERIAL_JTAG

################################################################################
# OTA
################################################################################
ota:
  - platform: esphome
    password: !secret ota_pw

################################################################################
# Enable Home Assistant API
################################################################################
api:
  id: ha_api
  encryption:
    key: !secret ha_api_pw
  on_client_connected:
    - if:
        condition:
          lambda: 'return (0 == client_info.find("Home Assistant "));'
        then:
          - lvgl.label.update:
              id: lbl_hastatus
              text: "$wifi"
  on_client_disconnected:
    - if:
        condition:
          lambda: 'return (0 == client_info.find("Home Assistant "));'
        then:
          - lvgl.label.update:
              id: lbl_hastatus
              text: "$wifi_off"

esp_ldo:
  - voltage: 2.5V
    channel: 3

################################################################################
# Web Server
################################################################################
web_server:
  port: 80
  version: 3
  include_internal: true

################################################################################
# Fonts
################################################################################
font:
  - file: "gfonts://Oswald@700"
    id: font_time
    size: 52
    bpp: 4
  - file: "gfonts://Material+Symbols+Rounded@700"
    id: font_wifi
    size: 52
    bpp: 4
    glyphs: [
      "$wifi",
      "$wifi_off",
      ]
  - file: "gfonts://Oswald@700"
    id: font_button
    size: 27
    bpp: 4
  - file: "gfonts://Oswald@700"
    id: font_date
    size: 22
    bpp: 4
  - file: "gfonts://Material+Symbols+Rounded@700"
    id: font_icons
    size: 40
    bpp: 4
    glyphs: [
      "$power",
      "$left",
      "$right",
      "$up",
      "$down",
      ]
  - file: "gfonts://Oswald@700"
    id: font_volume
    size: 34
    bpp: 4

################################################################################
# Colours
################################################################################
color:
  - id: lcars_beige
    hex: "E6CC99"
  - id: lcars_blue_gray
    hex: "99B3CC"
  - id: lcars_black
    hex: "000000"
  - id: lcars_white
    hex: "FFFFFF"
  - id: lcars_orange
    hex: "ff8800"
  - id: lcars_lightblue
    hex: "6c7acc"
  - id: lcars_red
    hex: "eb4e4e"
  - id: lcars_lightorange
    hex: "ff9c00"
  - id: lcars_lavender
    hex: "cc99ff"

################################################################################
# Sensors
################################################################################
sensor:
  # WiFi
  - platform: wifi_signal
    name: "WiFi Signal Sensor"
    id: wifi_signal_sensor
    update_interval: 10s

  - platform: uptime
    type: seconds
    name: Uptime
    update_interval: 60s

  - platform: homeassistant
    id: sonos_volume_level
    entity_id: media_player.speakers
    attribute: volume_level
    on_value:
      then:
        - logger.log:
            format: "Sonos volume state: %f"
            args: [ x ]
        - lvgl.slider.update:
            id: slider_media_player
            value: !lambda return (x * 100);
        - lvgl.label.update:
            id: lbl_volume_percentage
            text:
              format: "%.0f%%"
              args: [ x * 100 ]

  - platform: template
    name: "Voice Assistant State"
    lambda: |-
      if (id(esp32_microphone).is_running()) {
        return 1;
      } else {
        return 0;
      }
    update_interval: 2s
            

################################################################################
# Text Sensors
################################################################################
text_sensor:
  - platform: homeassistant
    id: ${device_internal_name}_lg_state
    entity_id: media_player.lg_webos_smart_tv
    attribute: source
    on_value:
      then:
        - logger.log:
            format: "LG state: %s"
            args: [ 'x.c_str()' ]
        - lvgl.widget.update:
            id: btn_iplayer
            state:
              checked: !lambda return (0 == x.compare(std::string{"BBC iPlayer"}));
        - lvgl.widget.update:
            id: btn_kodi
            state:
              checked: !lambda return (0 == x.compare(std::string{"Game Console"}));

  - platform: template
    name: "Voice Assistant Status"
    id: voice_status
    update_interval: 5s
    lambda: |-
      if (id(esp32_microphone).is_running()) {
        return {"Listening"};
      } else {
        return {"Idle"};
      }

################################################################################
# Binary Sensors
################################################################################
binary_sensor:
  - platform: homeassistant
    id: ${device_internal_name}_lounge_sputnik_lights_state
    entity_id: light.lounge_dimmer
    trigger_on_initial_state: true
    on_state:
      then:
        - logger.log:
            format: "Lounge Sputnik Lights state: %d"
            args: [ 'x' ]
        - lvgl.widget.update:
            id: btn_lounge_sputnik_lights
            state:
              checked: !lambda return x;

  - platform: homeassistant
    id: ${device_internal_name}_lounge_uplights_state
    entity_id: light.lounge_uplights
    trigger_on_initial_state: true
    on_state:
      then:
        - logger.log:
            format: "Lounge Uplights state: %d"
            args: [ 'x' ]
        - lvgl.widget.update:
            id: btn_lounge_uplights
            state:
              checked: !lambda return x;

  - platform: homeassistant
    id: ${device_internal_name}_lg_power_state
    entity_id: media_player.lg_webos_smart_tv
    trigger_on_initial_state: true
    on_state:
      then:
        - logger.log:
            format: "LG Power state: %d"
            args: [ 'x' ]
        - lvgl.widget.update:
            id: btn_lg_power
            state:
              checked: !lambda return x;


  - platform: status
    name: "Status"
    id: "${device_internal_name}_status"
    icon: mdi:check-network
    entity_category: diagnostic

# -------------------------------------------
# Audio devices
# -------------------------------------------
i2s_audio:
  - id: audio_bus
    i2s_mclk_pin: GPIO13
    i2s_lrclk_pin: GPIO10
    i2s_bclk_pin: GPIO12

audio_dac:
  - platform: es8311
    id: es8311_dac
    i2c_id: bus_a
    use_microphone: True

audio_adc:
  - platform: es7210
    id: es7210_adc
    i2c_id: bus_a
    address: 0x36

microphone:
  - platform: i2s_audio
    id: esp32_microphone
    i2s_audio_id: audio_bus
    i2s_din_pin: GPIO11
    sample_rate: 16000
    bits_per_sample: 16bit
    adc_type: external
    # on_data:
    #   - logger.log:
    #       format: "Microphone data received: %d bytes"
    #       args: [x.size()]

speaker:
  - platform: i2s_audio
    id: esp32_speaker
    i2s_audio_id: audio_bus
    i2s_dout_pin: GPIO9
    audio_dac: es8311_dac
    dac_type: external
    channel: stereo
    # buffer_duration: 100ms
    bits_per_sample: 16bit
    sample_rate: 16000

  - platform: mixer
    id: mixing_speaker
    output_speaker: esp32_speaker
    source_speakers:
      - id: announcement_mixing_input
        # timeout: never
      - id: media_mixing_input
        # timeout: never

  - platform: resampler
    id: announcement_resampling_speaker
    output_speaker: announcement_mixing_input
    # sample_rate: 48000
    # bits_per_sample: 16

  - platform: resampler
    id: media_resampling_speaker
    output_speaker: media_mixing_input
    # sample_rate: 48000
    # bits_per_sample: 16

switch:
  - platform: gpio
    pin: GPIO53  # BSP_POWER_AMP_IO
    name: "Audio Amplifier"
    id: audio_amplifier
    restore_mode: ALWAYS_OFF

media_player:
  - platform: speaker
    name: "ESP32 P4 Media Player"
    id: speaker_media_player
    codec_support_enabled: true
    # buffer_size: 2000000
    # task_stack_in_psram: true
    volume_min: 0.5
    volume_max: 0.75
    volume_increment: 0.05
    announcement_pipeline:
      speaker: announcement_resampling_speaker
      format: FLAC
      # sample_rate: 48000
      sample_rate: 16000
      num_channels: 2
    media_pipeline:
      speaker: media_resampling_speaker
      format: FLAC
      num_channels: 1
      # sample_rate: 48000
      sample_rate: 16000
    on_announcement:
      - if:
          condition:
            - microphone.is_capturing:
          then:
            - micro_wake_word.stop
            - voice_assistant.stop
      - mixer_speaker.apply_ducking:
          id: media_mixing_input
          decibel_reduction: 20
          duration: 0.0s
      - switch.turn_on: audio_amplifier
      - delay: 100ms
    on_state:
      if:
        condition:
          and:
            - not:
                voice_assistant.is_running:
            - not:
                media_player.is_announcing:
        then:
          - mixer_speaker.apply_ducking:
              id: media_mixing_input
              decibel_reduction: 0
              duration: 1.0s
    on_play:
      - logger.log: "Media player started playing, disabling microphone"
      - switch.turn_on: audio_amplifier
      - delay: 100ms
      - micro_wake_word.stop
      - voice_assistant.stop
    on_idle:
      - delay: 100ms
      - switch.turn_off: audio_amplifier
      - if:
          condition:
            not:
              voice_assistant.is_running:
          then:
            - micro_wake_word.start


micro_wake_word:
  id: my_wake_word
  models:
    - model: alexa
  on_wake_word_detected:
    then:
      - logger.log: "Wake word detected"
      - voice_assistant.start:
          wake_word: !lambda return wake_word;

voice_assistant:
  microphone: esp32_microphone
  media_player: speaker_media_player
  micro_wake_word: my_wake_word
  noise_suppression_level: 2
  auto_gain: 31dBFS
  volume_multiplier: 2.0
  conversation_timeout: 300s
  on_end:
    # Wait a short amount of time to see if an announcement starts
    - wait_until:
        condition:
          - media_player.is_announcing:
        timeout: 0.5s
    # Announcement is finished and the I2S bus is free
    - wait_until:
        - and:
            - not:
                media_player.is_announcing:
            - not:
                media_player.is_playing:
    - micro_wake_word.start:
  on_client_connected:
    - micro_wake_word.start:
  on_client_disconnected:
    - micro_wake_word.stop:
  
################################################################################
# Time
################################################################################
time:
  - platform: homeassistant
    id: homeassistant_time
    on_time_sync:
      - script.execute: time_update
    on_time:
      - minutes: '*'
        seconds: 0
        then:
          - script.execute: time_update

script:
  - id: time_update
    then:
      - lvgl.label.update:
          id: lbl_current_time
          text:
            time_format: "%R"
            time: !lambda return id(homeassistant_time).now();
      - lvgl.label.update:
          id: lbl_current_date
          text:
            time_format: "%A %b %d %Y"
            time: !lambda return id(homeassistant_time).now();

# -------------------------------------------
# Touchscreen gt911 i2c
# -------------------------------------------
i2c:
  - id: bus_a
    sda: GPIO07
    scl: GPIO08
    frequency: 400kHz

i2c_device:
  - id: i2cdev1
    address: 0x18
  - id: i2cdev2
    address: 0x32
  - id: i2cdev3
    address: 0x36
  - id: i2cdev4
    address: 0x40

touchscreen:
  - platform: gt911
    id: my_touchscreen
    i2c_id: bus_a
    reset_pin: GPIO22
    update_interval: 50ms
    transform:
      swap_xy: true
      mirror_x: false
      mirror_y: true
    # on_touch:
    #   - lambda: |-
    #         ESP_LOGI("cal", "x=%d, y=%d, x_raw=%d, y_raw=%0d",
    #             touch.x,
    #             touch.y,
    #             touch.x_raw,
    #             touch.y_raw
    #             );

# -------------------------------------------
# Backlight
# -------------------------------------------
output:
  - platform: ledc
    pin: GPIO23
    id: gpio_backlight_pwm
    frequency: 100Hz
    min_power: 0.03
    zero_means_zero: true

light:
  - platform: monochromatic
    output: gpio_backlight_pwm
    name: Display Backlight
    icon: mdi:lightbulb-on
    id: display_backlight
    restore_mode: ALWAYS_ON

# -------------------------------------------
# Display
# -------------------------------------------
display:
  - platform: mipi_dsi
    id: my_display
    model: JC1060P470
    reset_pin:
      number: GPIO05
    rotation: 90
    update_interval: never
    auto_clear_enabled: false
    hsync_pulse_width: 20

################################################################################
# Background
################################################################################
image:
  - file: "images/background2.svg"  # Relative path
    id: lcars_background
    type: RGB565
    resize: 600x1024
    byte_order: little_endian

################################################################################
# LVGL
################################################################################
lvgl:
  displays: my_display
  touchscreens: my_touchscreen
# LVGL settings required for this display
  buffer_size: 100%
  byte_order: little_endian
  # color_depth: 32

  theme:
    button:
      width: 36%
      height: 15%
      bg_color: lcars_lightblue  # Off / Unchecked
      bg_opa: 40%
      radius: 35
      border_width: 0
      shadow_opa: TRANSP
      pressed:
        bg_color: lcars_lightorange
        bg_opa: COVER
      checked:
        bg_color: lcars_orange
        bg_opa: COVER
    label:
      border_width: 0

  style_definitions:
    - id: header_footer
      radius: 0
      pad_all: 0
      text_color: lcars_orange
      bg_color: lcars_black
      border_width: 0
      bg_opa: COVER
    - id: text_button
      align: CENTER
      text_align: CENTER
      text_font: font_button
      text_color: lcars_black
    - id: icon_button
      align: CENTER
      text_align: CENTER
      text_font: font_icons
      text_color: lcars_black
  pages:
    - id: main_page
      widgets:
        # Root object with the background image
        - obj:
            x: 0
            y: 0
            width: 100%
            height: 100%
            bg_color: lcars_black
            bg_image_src: lcars_background
            bg_image_opa: COVER
            border_width: 0
            pad_all: 0

        # Time and Date area
        - obj:
            x: 19%
            y: 0
            width: 70%
            height: 12%
            styles: header_footer
            align: TOP_LEFT
            widgets:
              - label:
                  id: lbl_current_time
                  align: TOP_LEFT
                  text_font: font_time
                  text: " "
              - label:
                  id: lbl_hastatus
                  align: TOP_RIGHT
                  text: "$wifi_off"
                  text_font: font_wifi
              - label:
                  id: lbl_current_date
                  align: CENTER
                  text_font: font_date
                  text: " "

        # Button grid
        - obj:
            x: 25%
            y: 21%
            width: 75%
            height: 62%
            bg_opa: TRANSP
            pad_all: 0
            border_width: 0
            layout:
              type: GRID
              grid_columns: [FR(1), FR(1)]
              grid_rows: [FR(1), FR(1), FR(1), FR(1), FR(1)]
              pad_row: 10
              pad_column: 10
            widgets:
              # Row 1: Lounge Sputnik Lights (left) and Lounge Uplights (right)
              - button:
                  id: btn_lounge_sputnik_lights
                  grid_cell_column_pos: 0
                  grid_cell_row_pos: 0
                  on_click:
                    then:
                      - logger.log: "Lounge Lights button clicked!"
                      # - dfplayer.play_mp3: 3
                      - homeassistant.action:
                          action: light.toggle
                          data:
                            entity_id: light.lounge_dimmer
                  widgets:
                    - label:
                        styles: text_button
                        text: "LOUNGE\nSPUTNIK"
              - button:
                  id: btn_lounge_uplights
                  grid_cell_column_pos: 1
                  grid_cell_row_pos: 0
                  on_click:
                    then:
                      - logger.log: "Lounge Uplights button clicked!"
                      # - dfplayer.play_mp3: 3
                      - homeassistant.action:
                          action: light.toggle
                          data:
                            entity_id: light.lounge_uplights
                  widgets:
                    - label:
                        styles: text_button
                        text: "LOUNGE\nUPLIGHTS"

              # Row 2: Kodi (left) and iPlayer (right)
              - button:
                  id: btn_kodi
                  grid_cell_column_pos: 0
                  grid_cell_row_pos: 1
                  on_click:
                    then:
                      - logger.log: "Kodi button clicked!"
                      # - dfplayer.play_mp3: 3
                      - homeassistant.action:
                          action: media_player.turn_on
                          data:
                            entity_id: media_player.lg_webos_smart_tv
                      - homeassistant.action:
                          action: media_player.select_source
                          data:
                            entity_id: media_player.lg_webos_smart_tv
                            source: Game Console
                  widgets:
                    - label:
                        styles: text_button
                        text: "KODI"
              - button:
                  id: btn_iplayer
                  grid_cell_column_pos: 1
                  grid_cell_row_pos: 1
                  on_click:
                    then:
                      - logger.log: "iPlayer button clicked!"
                      # - dfplayer.play_mp3: 3
                      - homeassistant.action:
                          action: media_player.turn_on
                          data:
                            entity_id: media_player.lg_webos_smart_tv
                      - homeassistant.action:
                          action: media_player.select_source
                          data:
                            entity_id: media_player.lg_webos_smart_tv
                            source: BBC iPlayer
                      - delay: 5s
                      - homeassistant.action:
                          action: webostv.button
                          data:
                            entity_id: media_player.lg_webos_smart_tv
                            button: ENTER
                  widgets:
                    - label:
                        styles: text_button
                        text: "IPLAYER"

              # Row 3: OK (left) and Power (right)
              - button:
                  id: btn_ok
                  grid_cell_column_pos: 0
                  grid_cell_row_pos: 2
                  on_click:
                    then:
                      - logger.log: "OK button clicked!"
                      # - dfplayer.play_mp3: 3
                      - homeassistant.action:
                          action: webostv.button
                          data:
                            entity_id: media_player.lg_webos_smart_tv
                            button: ENTER
                  widgets:
                    - label:
                        styles: text_button
                        text: "OK"
              - button:
                  id: btn_lg_power
                  grid_cell_column_pos: 1
                  grid_cell_row_pos: 2
                  on_click:
                    then:
                      - logger.log: "LG Power button clicked!"
                      # - dfplayer.play_mp3: 3
                      - homeassistant.action:
                          action: media_player.toggle
                          data:
                            entity_id: media_player.lg_webos_smart_tv
                  widgets:
                    - label:
                        styles: icon_button
                        text: "$power"

              # Row 4: Left (left) and Right (right)
              - button:
                  id: btn_left
                  grid_cell_column_pos: 0
                  grid_cell_row_pos: 3
                  on_click:
                    then:
                      - logger.log: "Right button clicked!"
                      # - dfplayer.play_mp3: 3
                      - homeassistant.action:
                          action: webostv.button
                          data:
                            entity_id: media_player.lg_webos_smart_tv
                            button: LEFT
                  widgets:
                    - label:
                        styles: icon_button
                        text: "$left"
              - button:
                  id: btn_right
                  grid_cell_column_pos: 1
                  grid_cell_row_pos: 3
                  on_click:
                    then:
                      - logger.log: "Right button clicked!"
                      # - dfplayer.play_mp3: 3
                      - homeassistant.action:
                          action: webostv.button
                          data:
                            entity_id: media_player.lg_webos_smart_tv
                            button: RIGHT
                  widgets:
                    - label:
                        styles: icon_button
                        text: "$right"

              # Row 5: Up (left) and Down (right)
              - button:
                  id: btn_up
                  grid_cell_column_pos: 0
                  grid_cell_row_pos: 4
                  on_click:
                    then:
                      - logger.log: "Up button clicked!"
                      # - dfplayer.play_mp3: 3
                      - homeassistant.action:
                          action: webostv.button
                          data:
                            entity_id: media_player.lg_webos_smart_tv
                            button: UP
                  widgets:
                    - label:
                        styles: icon_button
                        text: "$up"
              - button:
                  id: btn_down
                  grid_cell_column_pos: 1
                  grid_cell_row_pos: 4
                  on_click:
                    then:
                      - logger.log: "Down button clicked!"
                      # - dfplayer.play_mp3: 3
                      - homeassistant.action:
                          action: webostv.button
                          data:
                            entity_id: media_player.lg_webos_smart_tv
                            button: DOWN
                  widgets:
                    - label:
                        styles: icon_button
                        text: "$down"

        # Volume Percentage area
        - obj:
            styles: header_footer
            x: 96
            y: 960
            width: 412
            height: 68
            align: TOP_LEFT
            scrollbar_mode: "OFF"
            widgets:
              - slider:
                  id: slider_media_player
                  align: LEFT_MID
                  width: 300
                  height: 25
                  pad_all: 4
                  bg_color: lcars_lightblue
                  indicator:
                    bg_color: lcars_lightblue
                  knob:
                    bg_color: lcars_lightorange
                    pressed:
                      pad_all: 20
                  min_value: 0
                  max_value: 100
                  adv_hittest: True
                  on_change:
                    - homeassistant.action:
                        action: media_player.volume_set
                        data:
                          entity_id: media_player.speakers
                          volume_level: !lambda return (x / 100);
                  on_press:
                    then:
                      - logger.log: "Initital press of volume slider"
                      # - dfplayer.play_mp3: 2
                  on_release:
                    then:
                      - logger.log: "Release of volume slider"
                      # - dfplayer.play_mp3: 1
              - label:
                  id: lbl_volume_percentage
                  height: 68
                  width: 100
                  align: RIGHT_MID
                  text_align: RIGHT
                  text: "%"
                  text_font: font_volume
